
---

# üìÑ ARCHITECTURE.md

*ETL-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≤–∏—Ç—Ä–∏–Ω –æ–Ω–ª–∞–π–Ω-–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞ (Postgres ‚Üí Postgres / Elasticsearch)*

---

# 1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞

–û–Ω–ª–∞–π–Ω-–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ PostgreSQL (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ö–µ–º):

- `content` ‚Äî —Ñ–∏–ª—å–º—ã –∏ –∫–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
- `ugc` ‚Äî –æ—Ü–µ–Ω–∫–∏/–ª–∞–π–∫–∏/–ø—Ä–æ—á–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- `etl` ‚Äî –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ ETL (–ø–∞–π–ø–ª–∞–π–Ω—ã, –∑–∞–ø—É—Å–∫–∏, state)
- `analytics` ‚Äî –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–∏—Ç—Ä–∏–Ω—ã (Postgres sink)

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç sink –≤ **Elasticsearch** –¥–ª—è –≤–∏—Ç—Ä–∏–Ω/–ø–æ–∏—Å–∫–æ–≤—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ (ES sink).

–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è ETL-–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –∫–æ—Ç–æ—Ä–∞—è:

- —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ –≤ –ë–î (–∞ –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥–æ–º)
- –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è/—Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É —á–µ—Ä–µ–∑ REST API
- –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º Runner-–ø—Ä–æ—Ü–µ—Å—Å–æ–º (polling + state machine)
- –≤—ã–ø–æ–ª–Ω—è–µ—Ç **batched** –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö
- –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **full** –∏ **incremental** —Ä–µ–∂–∏–º—ã
- –ø–∏—à–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤:
  - Postgres (`analytics.*`)
  - Elasticsearch (`es:<index>`)
- —É–º–µ–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤ (recovery + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

---

# 2. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## 2.1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **ETL API (FastAPI)**  
  Control-plane: CRUD –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ (RUN/PAUSE), –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤.
  ETL API **–Ω–µ –∏—Å–ø–æ–ª–Ω—è–µ—Ç** –ø–∞–π–ø–ª–∞–π–Ω—ã.

- **ETL Runner (Python worker)**  
  Data-plane: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ë–î, ‚Äú–∑–∞–±–∏—Ä–∞–µ—Ç‚Äù –ø–∞–π–ø–ª–∞–π–Ω—ã –≤ —Ä–∞–±–æ—Ç—É, –≤—ã–ø–æ–ª–Ω—è–µ—Ç —á—Ç–µ–Ω–∏–µ/—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é/–∑–∞–ø–∏—Å—å, –æ–±–Ω–æ–≤–ª—è–µ—Ç state –∏ runs.

- **Postgres**  
  –•—Ä–∞–Ω–∏—Ç:
  - source –¥–∞–Ω–Ω—ã–µ (`content`, `ugc`)
  - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (`etl`)
  - Postgres-–≤–∏—Ç—Ä–∏–Ω—ã (`analytics`)

- **Elasticsearch**  
  Sink –¥–ª—è –≤–∏—Ç—Ä–∏–Ω –≤ –≤–∏–¥–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä `film_dim`, `film_rating_agg`).

## 2.2. –î–∏–∞–≥—Ä–∞–º–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π

```

Client
|
v
+------------------+         +-------------------------+
|    ETL API        | <-----> | Postgres                |
|  (FastAPI)        |         | - content, ugc (source) |
| - CRUD pipelines  |         | - etl (meta/state)      |
| - run/pause       |         | - analytics (target)    |
+------------------+         +-------------------------+
^
|  polling (tick)
|
+------------------+
|   ETL Runner      | -----> Elasticsearch (sink)
| (Python worker)   |        - indexes: film_dim, ...
| - state machine   |
| - batch ETL        |
+------------------+

```

---

# 3. Docker Compose

–í compose –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è:

- `etl_db` (Postgres)
- `etl_api` (FastAPI)
- `etl_runner` (worker)
- `elasticsearch` (ES sink)

Runner –ø–æ–ª—É—á–∞–µ—Ç ES URL —á–µ—Ä–µ–∑ env:
- `ELASTICSEARCH_URL=http://elasticsearch:9200`

---

# 4. –ú–æ–¥–µ–ª—å –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## 4.1. –ü–∞–π–ø–ª–∞–π–Ω (EtlPipeline)

–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:

- `type`: `"SQL"` / `"PYTHON"` (MVP: SQL, Python ‚Äî —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å)
- `mode`: `"full"` / `"incremental"`
- `source_query`: SQL-–∏—Å—Ç–æ—á–Ω–∏–∫ (–¥–ª—è SQL —Ä–µ–∂–∏–º–∞)
- `target_table`:
  - `"analytics.<table>"` –¥–ª—è Postgres sink
  - `"es:<index>"` –¥–ª—è Elasticsearch sink
- `batch_size`
- `enabled`
- `status` (—Å–º. state machine)

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:

–ü–∞–π–ø–ª–∞–π–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

- **Legacy mode** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `source_query` –ø–∞–π–ø–ª–∞–π–Ω–∞
- **Tasks mode** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω—ã–π task plan (`etl_pipeline_tasks`)

–ï—Å–ª–∏ task plan –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –æ–Ω –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ `source_query`.

## 4.2. –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ sink-—Ü–µ–ª–∏

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç ‚Äú–∫—É–¥–∞ –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å‚Äù, —á—Ç–æ–±—ã –Ω–µ –¥–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω–æ–º —Å–ª—É—á–∞–π–Ω–æ –ø–∏—Å–∞—Ç—å –≤ –ª—é–±—É—é —Ç–∞–±–ª–∏—Ü—É/–∏–Ω–¥–µ–∫—Å.

–í `src/app/core/constants.py`:

- `ALLOWED_TARGET_TABLES` ‚Äî –¥–æ–ø—É—Å—Ç–∏–º—ã–µ Postgres-—Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä `analytics.film_dim`, `analytics.film_rating_agg`)
- `ES_TARGET_PREFIX = "es:"`
- `ALLOWED_ES_INDEXES` ‚Äî –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã ES (–Ω–∞–ø—Ä–∏–º–µ—Ä `film_dim`, `film_rating_agg`)
- `is_allowed_target(target: str) -> bool` ‚Äî –µ–¥–∏–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è API –∏ writer-–ª–æ–≥–∏–∫–æ–π)

## 4.3. Pipeline Tasks (v1)

–ù–∞—á–∏–Ω–∞—è —Å –≤–µ—Ä—Å–∏–∏ v1, –ø–∞–π–ø–ª–∞–π–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∏—Å–∞–Ω **–Ω–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º `source_query`**,  
–Ω–æ –∏ **–ø–ª–∞–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (task plan)** ‚Äî –ª–∏–Ω–µ–π–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é —à–∞–≥–æ–≤.

–ï—Å–ª–∏ —É –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ tasks (`etl.etl_pipeline_tasks`), —Ç–æ:
- `source_query` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –∫–∞–∫ legacy fallback**
- —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è **task plan‚Äô–æ–º**
- Runner –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç `source_query` –∏ –∏—Å–ø–æ–ª–Ω—è–µ—Ç pipeline —á–µ—Ä–µ–∑ tasks

### Task plan (v1)

Task plan ‚Äî —ç—Ç–æ **—É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤**, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –ø–∞–π–ø–ª–∞–π–Ω–æ–º.

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è v1 (–æ—Å–æ–∑–Ω–∞–Ω–Ω—ã–π MVP):

- —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **—Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ**
- **–ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî SQL reader**
- –æ—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ ‚Äî **Python transforms**
- DAG, branching –∏ fan-out **–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è**
- pipeline –æ—Å—Ç–∞—ë—Ç—Å—è **–æ–¥–Ω–∏–º execution unit**

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, tasks v1 ‚Äî —ç—Ç–æ –Ω–µ workflow-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä,  
–∞ **—Ä–∞—Å—à–∏—Ä—è–µ–º—ã–π execution-–ø–ª–∞–Ω –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞**.

### –ü—Ä–∏–º–µ—Ä (conceptual)

[ SQL reader ] ‚Üí [ Python transform ] ‚Üí [ Python transform ] ‚Üí sink

Sink –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è:
- –ª–∏–±–æ `pipeline.target_table`
- –ª–∏–±–æ `task.target_table` **—Ç–æ–ª—å–∫–æ —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —à–∞–≥–∞**

### –í–∞–ª–∏–¥–∞—Ü–∏—è task plan

–ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º pipeline —Å tasks Runner –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å—Ç—Ä–æ–≥—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é:

- –ø–æ—Ä—è–¥–æ–∫ —à–∞–≥–æ–≤ (`order_index`)
- —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤
- –Ω–µ–ø—É—Å—Ç—ã–µ `task_type` –∏ `body`
- –ø–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî SQL
- –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ ‚Äî —Ç–æ–ª—å–∫–æ PYTHON
- `target_table` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω **—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–º —à–∞–≥–æ–º**
- –∏—Ç–æ–≥–æ–≤—ã–π target –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ `is_allowed_target`

–ï—Å–ª–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞—Ä—É—à–µ–Ω, execution **–Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è**.

---

# 5. State machine –ø–∞–π–ø–ª–∞–π–Ω–∞

–ü–∞–π–ø–ª–∞–π–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å–∞–º–∏. API –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç ‚Äú–∑–∞–ø—Ä–æ—Å‚Äù –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ, Runner –µ–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.

–°—Ç–∞—Ç—É—Å—ã:

- `IDLE` ‚Äî –≥–æ—Ç–æ–≤, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç
- `RUN_REQUESTED` ‚Äî API –∑–∞–ø—Ä–æ—Å–∏–ª –∑–∞–ø—É—Å–∫
- `RUNNING` ‚Äî Runner –∑–∞–±—Ä–∞–ª –≤ —Ä–∞–±–æ—Ç—É (claim)
- `PAUSE_REQUESTED` ‚Äî API –∑–∞–ø—Ä–æ—Å–∏–ª –ø–∞—É–∑—É
- `PAUSED` ‚Äî Runner –æ—Å—Ç–∞–Ω–æ–≤–∏–ª –ø–æ—Å–ª–µ batch –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª state
- `FAILED` ‚Äî –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–°—Ö–µ–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ):

```

IDLE -> RUN_REQUESTED -> RUNNING -> IDLE
RUNNING -> PAUSE_REQUESTED -> PAUSED
PAUSED -> RUN_REQUESTED -> RUNNING
RUNNING -> FAILED (–µ—Å–ª–∏ –æ—à–∏–±–∫–∞)

```

–í–∞–∂–Ω–æ:
- Runner –¥–µ–ª–∞–µ—Ç **claim** `RUN_REQUESTED -> RUNNING` –∞—Ç–æ–º–∞—Ä–Ω–æ (—á—Ç–æ–±—ã –¥–≤–∞ —Ä–∞–Ω–Ω–µ—Ä–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –æ–¥–∏–Ω –ø–∞–π–ø–ª–∞–π–Ω).
- –ü–∞—É–∑–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **–º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏**: Runner –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±–∞—Ç—á, –∫–æ–º–º–∏—Ç–∏—Ç state, —Å—Ç–∞–≤–∏—Ç `PAUSED`.

---

# 6. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ETL Runner

Runner –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω –∫–∞–∫ OOP-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è:

## 6.1. PipelineManager

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–∏–Ω ‚Äú—Ç–∏–∫‚Äù:
- –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤-–∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ (enabled + RUN_REQUESTED/PAUSE_REQUESTED)
- –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∂–¥—ã–π –ø–∞–π–ø–ª–∞–π–Ω –≤ **fresh DB session** (–∏–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
- –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Ä—É–∂—É —Ç–æ–ª—å–∫–æ DB-disconnect (—á—Ç–æ–±—ã main_loop –º–æ–≥ –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)

## 6.2. PipelineDispatcher

–†–æ—É—Ç–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤:
- `PAUSE_REQUESTED` ‚Üí –ø—Ä–∏–º–µ–Ω–∏—Ç—å pause –∏ –≤—ã–π—Ç–∏
- `RUN_REQUESTED` ‚Üí claim –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ Executor
- `RUNNING` ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–¥—Ä—É–≥–æ–π —Ä–∞–Ω–Ω–µ—Ä/—Å–æ—Å—Ç–æ—è–Ω–∏–µ)

–¢–∞–∫–∂–µ Dispatcher –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ retry/backoff –Ω–∞ ‚Äú–æ–±—ã—á–Ω—ã—Ö‚Äù –æ—à–∏–±–∫–∞—Ö:
- `MAX_ATTEMPTS = 3`
- `BACKOFF_SECONDS = (1, 2, 4)`

–û—à–∏–±–∫–∏ disconnect (DB down/DNS/connection closed) –Ω–µ —Ä–µ—Ç—Ä–∞—è—Ç—Å—è ‚Äú–≤–Ω—É—Ç—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è‚Äù ‚Äî Runner –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Ç–∏–∫–∞, –∞ recovery –∑–∞–±–∏—Ä–∞–µ—Ç ‚Äú–∑–∞–ª–∏–ø—à–∏–µ RUNNING‚Äù.

## 6.3. PipelineExecutor

–ò—Å–ø–æ–ª–Ω—è–µ—Ç ‚ÄúETL-–∫—É—Ö–Ω—é‚Äù –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `mode` –∏ `type`:

- full:
  - read batch –∏–∑ `source_query`
  - transform
  - write sink
- incremental:
  - —á–∏—Ç–∞–µ—Ç `etl_state` (checkpoint)
  - –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π batch –ø–æ `(incremental_key, incremental_id_key)`
  - –ø–æ—Å–ª–µ batch –æ–±–Ω–æ–≤–ª—è–µ—Ç state –∏ –¥–µ–ª–∞–µ—Ç commit
  - 
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å incremental execution —Å tasks:

Checkpoint (`etl_state`) –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è **–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É SQL reader**,
–∞ –Ω–µ –ø–æ –¥–∞–Ω–Ω—ã–º –ø–æ—Å–ª–µ Python transforms.

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:
- –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫—É—Ä—Å–æ—Ä –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞
- –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å state –æ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π

PipelineExecutor —Ç–∞–∫–∂–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞:

- –µ—Å–ª–∏ —É –ø–∞–π–ø–ª–∞–π–Ω–∞ **–Ω–µ—Ç tasks**:
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è legacy execution
  - `sql_full` –∏–ª–∏ `sql_incremental`

- –µ—Å–ª–∏ —É –ø–∞–π–ø–ª–∞–π–Ω–∞ **–µ—Å—Ç—å tasks**:
  - –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è task plan (v1 contract)
  - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `tasks_full` –∏–ª–∏ `tasks_incremental`

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, Executor —è–≤–ª—è–µ—Ç—Å—è **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Ç–æ—á–∫–æ–π**, –≥–¥–µ
—Å—Ö–æ–¥—è—Ç—Å—è –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è ETL.

Executor —Ç–∞–∫–∂–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ `etl_runs` (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞) –∏ –ø—Ä–∏–≤–æ–¥–∏—Ç pipeline status –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é (IDLE/FAILED/PAUSED) —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º.

---

# 7. Adapters / Ports

Runner –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–¥–∞–ø—Ç–µ—Ä—ã (MVP):

- `adapters/sql_full.py` ‚Äî full-–ø—Ä–æ–≥–æ–Ω
- `adapters/sql_incremental.py` ‚Äî incremental-–ø—Ä–æ–≥–æ–Ω (checkpoint)
- `adapters/transformers.py` ‚Äî resolve_transformer(...)
- `adapters/writers.py` ‚Äî resolve_writer(...)

## 7.1. Transformers

Transformer –ø–æ–ª—É—á–∞–µ—Ç rows –∏–∑ SQLAlchemy (`mappings()`), –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–¥ writer.
(–í MVP —á–∞—â–µ –≤—Å–µ–≥–æ pass-through + –ª—ë–≥–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è).

## 7.2. Writers

–í—ã–±–æ—Ä writer –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `target_table`:

- `analytics.*` ‚Üí `PostgresWriter` (UPSERT)
- `es:<index>` ‚Üí `ElasticsearchWriter` (bulk upsert)

### PostgresWriter
- –≤—ã–ø–æ–ª–Ω—è–µ—Ç UPSERT (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- –ø–∏—à–µ—Ç –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –≤–∏—Ç—Ä–∏–Ω (`ALLOWED_TARGET_TABLES`)

### ElasticsearchWriter
- –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å –∏–∑ `target_table` (prefix `es:`)
- –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `ALLOWED_ES_INDEXES`
- –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å (create –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) —Å MVP mappings
- –ø–∏—à–µ—Ç bulk `update` + `doc_as_upsert=true`
- –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–∏–ø—ã (UUID/Decimal/datetime ‚Üí JSON-friendly)

---

# 8. Recovery –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

## 8.1. Recovery ‚Äú–∑–∞–ª–∏–ø—à–∏—Ö RUNNING‚Äù

–ù–∞ —Å—Ç–∞—Ä—Ç–µ Runner –≤—ã–ø–æ–ª–Ω—è–µ—Ç recovery:
- –∏—â–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `RUNNING` (–ø–æ—Å–ª–µ –∫—Ä–∞—à–∞/kill)
- –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∏—Ö –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä `IDLE` –∏–ª–∏ `FAILED` ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∏–Ω—è—Ç–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞)
- –ª–æ–≥–∏—Ä—É–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö

## 8.2. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

- Postgres sink: UPSERT –ø–æ –∫–ª—é—á—É (–Ω–∞–ø—Ä–∏–º–µ—Ä `film_id`)
- ES sink: upsert —á–µ—Ä–µ–∑ bulk update (`doc_as_upsert`)

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∑–∞–ø—É—Å–∫.

---

# 9. MVP –≤–∏—Ç—Ä–∏–Ω—ã

## 9.1. film_dim
- Postgres: `analytics.film_dim`
- ES: `es:film_dim` ‚Üí –∏–Ω–¥–µ–∫—Å `film_dim`

–ü—Ä–∏–º–µ—Ä: `film_id`, `title`, `rating`

## 9.2. film_rating_agg
- Postgres: `analytics.film_rating_agg`
- ES: `es:film_rating_agg` ‚Üí –∏–Ω–¥–µ–∫—Å `film_rating_agg`

–ü—Ä–∏–º–µ—Ä: `film_id`, `avg_rating`, `rating_count`

---

# 10. ETL API (–∫–æ–Ω—Ç—Ä–æ–ª—å)

API –¥–∞—ë—Ç:
- CRUD –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
- –∑–∞–ø—É—Å–∫/–ø–∞—É–∑–∞
- –∏—Å—Ç–æ—Ä–∏—è –∑–∞–ø—É—Å–∫–æ–≤ (runs)

Runner —á–∏—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ë–î (polling), –±–µ–∑ –ø—Ä—è–º–æ–π —Å–≤—è–∑–∏ API ‚Üí Runner.

---

# 11. –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å (—á—Ç–æ –¥–∞–ª—å—à–µ)

–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–∫, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å:

- –Ω–æ–≤—ã–µ sink‚Äô–∏ (ClickHouse, S3, etc.) —á–µ—Ä–µ–∑ Writer
- python-–ø–∞–π–ø–ª–∞–π–Ω—ã (`type=PYTHON`) —á–µ—Ä–µ–∑ transformer/adapter
- –≤–Ω–µ—à–Ω—é—é –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é (Airflow) ‚Äî API –æ—Å—Ç–∞—ë—Ç—Å—è control-plane, runner –∏—Å–ø–æ–ª–Ω—è–µ—Ç

---

–û—Ç–ª–∏—á–Ω–æ. –¢–æ–≥–¥–∞ –¥–µ–ª–∞–µ–º **–≤—Ç–æ—Ä—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é ARCHITECTURE.md** ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ã—á–Ω–æ **–æ—á–µ–Ω—å –ª—é–±—è—Ç —Ä–µ–≤—å—é–µ—Ä—ã** –∏ –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª—å–Ω–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ç–µ–±–µ —Å–∞–º–æ–º—É:
üëâ **—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è + –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å–ª–æ—ë–≤**.

–ù–∏–∂–µ ‚Äî **–≥–æ—Ç–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –∫–æ–ø–∏–ø–∞—Å—Ç–∞**, –µ–≥–æ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ **–¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü** —Ç–µ–∫—É—â–µ–≥–æ `ARCHITECTURE.md` (–∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–∞–∑–¥–µ–ª–∞ –ø—Ä–æ Runner).

---

---

# 12. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å–ª–æ—ë–≤

–ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–¥–µ–ª—ë–Ω –Ω–∞ **control-plane (API)** –∏ **data-plane (Runner)**.  
–ö–∞–∂–¥—ã–π —Å–ª–æ–π –∏–º–µ–µ—Ç —á—ë—Ç–∫—É—é –∑–æ–Ω—É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –Ω–µ ‚Äú–ª–µ–∑–µ—Ç‚Äù –≤ —á—É–∂–∏–µ.

## 12.1. –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```

‚îÇ   .env.sample
‚îÇ   .gitignore
‚îÇ   Dockerfile
‚îÇ   Makefile
‚îÇ   README.md
‚îÇ   requirements.txt
‚îÇ   
‚îú‚îÄ‚îÄ‚îÄdocs
‚îÇ       API.md
‚îÇ       ARCHITECTURE.md
‚îÇ       demo_script.md
‚îÇ       demo_short.md
‚îÇ       demo_short_script_v2.md
‚îÇ       demo_smoke_tests_v2.md
‚îÇ       PLAN.md
‚îÇ       Technical_Requirements.md
‚îÇ
‚îú‚îÄ‚îÄ‚îÄinfra
‚îÇ   ‚îÇ   docker-compose.yml
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄpostgres
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄinit
‚îÇ               01_schemas.sql
‚îÇ               02_content_tables.sql
‚îÇ               03_ugc_tables.sql
‚îÇ               04_analytics_tables.sql
‚îÇ               05_etl_tables.sql
‚îÇ               06_sample_data.sql
‚îÇ               07_sample_ratings.sql
‚îÇ               08_add_incremental_id_key.sql
‚îÇ
‚îú‚îÄ‚îÄ‚îÄsql
‚îÇ       init_demo_data.sql
‚îÇ
‚îú‚îÄ‚îÄ‚îÄsrc
‚îÇ   ‚îÇ   __init__.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄapp
‚îÇ   ‚îÇ   ‚îÇ   db.py
‚îÇ   ‚îÇ   ‚îÇ   dependencies.py
‚îÇ   ‚îÇ   ‚îÇ   main.py
‚îÇ   ‚îÇ   ‚îÇ   __init__.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄapi
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄhelpers
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       pipelines.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       __init__.py
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄv1
‚îÇ   ‚îÇ   ‚îÇ           pipelines.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄcore
‚îÇ   ‚îÇ   ‚îÇ       constants.py
‚îÇ   ‚îÇ   ‚îÇ       enums.py
‚îÇ   ‚îÇ   ‚îÇ       exceptions.py
‚îÇ   ‚îÇ   ‚îÇ       __init__.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄmodels
‚îÇ   ‚îÇ   ‚îÇ       base.py
‚îÇ   ‚îÇ   ‚îÇ       etl_pipeline.py
‚îÇ   ‚îÇ   ‚îÇ       etl_pipeline_task.py
‚îÇ   ‚îÇ   ‚îÇ       etl_run.py
‚îÇ   ‚îÇ   ‚îÇ       etl_state.py
‚îÇ   ‚îÇ   ‚îÇ       __init__.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄrepositories
‚îÇ   ‚îÇ   ‚îÇ       interfaces.py
‚îÇ   ‚îÇ   ‚îÇ       pipelines.py
‚îÇ   ‚îÇ   ‚îÇ       __init__.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ‚îÄschemas
‚îÇ   ‚îÇ   ‚îÇ       pipelines.py
‚îÇ   ‚îÇ   ‚îÇ       __init__.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄservices
‚îÇ   ‚îÇ           pipelines.py
‚îÇ   ‚îÇ           __init__.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄconfig
‚îÇ   ‚îÇ       settings.py
‚îÇ   ‚îÇ       __init__.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ‚îÄpipelines
‚îÇ   ‚îÇ   ‚îÇ   __init__.py
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄpython_demo
‚îÇ   ‚îÇ           demo_film_dim.py
‚îÇ   ‚îÇ           __init__.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄrunner
‚îÇ       ‚îÇ   main.py
‚îÇ       ‚îÇ   __init__.py
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄadapters
‚îÇ       ‚îÇ       sql_full.py
‚îÇ       ‚îÇ       sql_incremental.py
‚îÇ       ‚îÇ       transformers.py
‚îÇ       ‚îÇ       writers.py
‚îÇ       ‚îÇ       __init__.py
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄorchestration
‚îÇ       ‚îÇ       dispatcher.py
‚îÇ       ‚îÇ       executor.py
‚îÇ       ‚îÇ       manager.py
‚îÇ       ‚îÇ       __init__.py
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄports
‚îÇ       ‚îÇ       pipeline.py
‚îÇ       ‚îÇ       reader.py
‚îÇ       ‚îÇ       transform.py
‚îÇ       ‚îÇ       writer.py
‚îÇ       ‚îÇ       __init__.py
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ‚îÄrepos
‚îÇ       ‚îÇ       pipelines.py
‚îÇ       ‚îÇ       runs.py
‚îÇ       ‚îÇ       state.py
‚îÇ       ‚îÇ       __init__.py
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ‚îÄservices
‚îÇ               db_errors.py
‚îÇ               pipeline_snapshot.py
‚îÇ               time_utils.py
‚îÇ               __init__.py
‚îÇ
‚îú‚îÄ‚îÄ‚îÄtests
‚îÇ       __init__.py


```

---

## 12.2. ETL API (control-plane)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø–∞–π–ø–ª–∞–π–Ω–æ–≤.  
API **–Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç ETL**, –Ω–µ –∑–Ω–∞–µ—Ç –æ –±–∞—Ç—á–∞—Ö, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Elasticsearch –Ω–∞–ø—Ä—è–º—É—é.

### –ö–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã

#### `app/api/v1/pipelines.py`
- HTTP endpoints:
  - create/update pipeline
  - run / pause
  - list pipelines
  - list runs
- –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –≤ `services`

#### `app/services/pipelines.py`
- –ë–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞:
  - –≤–∞–ª–∏–¥–∞—Ü–∏—è `target_table` —á–µ—Ä–µ–∑ `is_allowed_target`
  - –∑–∞–ø—Ä–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è RUNNING –ø–∞–π–ø–ª–∞–π–Ω–∞
  - –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π `run_pipeline`
- –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç SQL

#### `app/repositories/sql_pipelines.py`
- –ß–∏—Å—Ç—ã–π –¥–æ—Å—Ç—É–ø –∫ –ë–î:
  - `get_pipeline`
  - `list_pipelines`
  - `request_run`
  - `request_pause`
- –ë–µ–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ –±–µ–∑ –∑–Ω–∞–Ω–∏–π –æ Runner

---

## 12.3. ETL Runner (data-plane)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**  
–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ETL —Å —É—á—ë—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è, retry/backoff, recovery.

Runner **–Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ HTTP** –∏ –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç FastAPI.

---

### 12.3.1. main.py

- `main_loop()`:
  - startup checks
  - recovery ‚Äú–∑–∞–ª–∏–ø—à–∏—Ö RUNNING‚Äù
  - –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π polling (`tick`)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ **–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏** (DB disconnect)

---

### 12.3.2. PipelineManager

–§–∞–π–ª: `runner/orchestration/manager.py`

–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- –Ω–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã
- –æ—Ç–∫—Ä—ã—Ç—å fresh DB session –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
- –≤—ã–∑–≤–∞—Ç—å Dispatcher
- –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–∞–¥–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

---

### 12.3.3. PipelineDispatcher

–§–∞–π–ª: `runner/orchestration/dispatcher.py`

–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É:
  - RUN_REQUESTED
  - PAUSE_REQUESTED
  - RUNNING
- atomic claim (`RUN_REQUESTED -> RUNNING`)
- retry + backoff:
  - 3 –ø–æ–ø—ã—Ç–∫–∏
  - 1 / 2 / 4 —Å–µ–∫—É–Ω–¥—ã
- —Ä–∞–∑–ª–∏—á–∞–µ—Ç:
  - –±–∏–∑–Ω–µ—Å-–æ—à–∏–±–∫–∏ (retry)
  - DB disconnect (–≤—ã—Ö–æ–¥ –∏–∑ tick)

---

### 12.3.4. PipelineExecutor

–§–∞–π–ª: `runner/orchestration/executor.py`

–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:
- –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
  - full
  - incremental
- –≤–µ–¥–µ–Ω–∏–µ `etl_runs`
- —Ñ–∏–∫—Å–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞
- –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ adapters

Executor ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –º–µ—Å—Ç–æ**, –≥–¥–µ ‚Äú—Å–æ–±–∏—Ä–∞–µ—Ç—Å—è‚Äù –≤–µ—Å—å ETL-–ø—Ä–æ—Ü–µ—Å—Å.

---

## 12.4. Adapters (–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ ETL)

Adapters ‚Äî —ç—Ç–æ ‚Äú–ø–ª–∞–≥–∏–Ω—ã‚Äù –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç orchestration.

### sql_full.py
- –≤—ã–ø–æ–ª–Ω—è–µ—Ç full batch SQL
- —á–∏—Ç–∞–µ—Ç `source_query`
- –±–∞—Ç—á–∞–º–∏ –≤—ã–∑—ã–≤–∞–µ—Ç transformer ‚Üí writer

### sql_incremental.py
- —á–∏—Ç–∞–µ—Ç `etl_state`
- –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `(incremental_key, incremental_id_key)`
- –æ–±–Ω–æ–≤–ª—è–µ—Ç checkpoint –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞
- –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pause

---

### transformers.py
- –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö —Å—Ç—Ä–æ–∫
- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥ writer
- –º–µ—Å—Ç–æ –¥–ª—è Python-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π –≤ –±—É–¥—É—â–µ–º

---

### writers.py

Sink-–∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è.

- `PostgresWriter`
  - UPSERT –≤ `analytics.*`
  - —Å—Ç—Ä–æ–≥–∏–π whitelist —Ç–∞–±–ª–∏—Ü

- `ElasticsearchWriter`
  - target_table = `es:<index>`
  - whitelist –∏–Ω–¥–µ–∫—Å–æ–≤
  - bulk upsert
  - auto-create index + mappings (MVP)
  - JSON-–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∏–ø–æ–≤

---

## 12.5. Ports

### `PipelineLike`

Protocol, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π:
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è:
  - SQLAlchemy –º–æ–¥–µ–ª–µ–π
  - snapshot-–æ–±—ä–µ–∫—Ç–æ–≤
- –∏–∑–±–µ–∂–∞—Ç—å –∂—ë—Å—Ç–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Runner –æ—Ç ORM

---

## 12.6. –ü–æ—á–µ–º—É —Ç–∞–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

- **API –∏ Runner –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–≤—è–∑–∞–Ω—ã**
- Runner –º–æ–∂–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
- –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å polling –Ω–∞ –≤–Ω–µ—à–Ω–∏–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
- –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö sink‚Äô–æ–≤ –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
- –∫–æ–¥ —á–∏—Ç–∞–µ—Ç—Å—è ‚Äú—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑‚Äù:
  - manager ‚Üí dispatcher ‚Üí executor ‚Üí adapters

---
