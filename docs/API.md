
---

````markdown
# üì° API.md ‚Äî –ß–µ—Ä–Ω–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç ETL API

*–í–µ—Ä—Å–∏—è: draft v0.1*  
*–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–æ –Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ FastAPI.*

---

## 1. –û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

- –ë–∞–∑–æ–≤—ã–π URL: `/api/v1`
- –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: `application/json`
- –í—Å–µ –æ—Ç–≤–µ—Ç—ã, –∫—Ä–æ–º–µ `204 No Content`, –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç JSON.
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ ‚Äî UUID (—Å—Ç—Ä–æ–∫–∞).
- –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç:

```json
{
  "detail": "–û—à–∏–±–∫–∞ —Å –ø–æ–Ω—è—Ç–Ω—ã–º —á–µ–ª–æ–≤–µ–∫—É –æ–ø–∏—Å–∞–Ω–∏–µ–º"
}
````

*(–¥–µ—Ç–∞–ª–∏, –∫–æ–¥—ã –æ—à–∏–±–æ–∫ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)*

---

## 2. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (–Ω–∞ —É—Ä–æ–≤–Ω–µ API)

### 2.1. Pipeline (–ø–∞–π–ø–ª–∞–π–Ω)

–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –≤ API:

```json
{
  "id": "uuid",
  "name": "film_dim_full",
  "description": "–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏—Ç—Ä–∏–Ω—ã –ø–æ —Ñ–∏–ª—å–º–∞–º",
  "type": "SQL",                // "SQL" –∏–ª–∏ "PYTHON"
  "mode": "full",               // "full" –∏–ª–∏ "incremental"
  "enabled": true,
  "status": "IDLE",             // IDLE/RUNNING/PAUSED/FAILED
  "target_table": "analytics.film_dim",
  "batch_size": 5000,
  "incremental_key": "modified", // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "created_at": "2025-01-01T10:00:00Z",
  "updated_at": "2025-01-01T10:00:00Z"
}
```

### 2.2. PipelineConfig (–¥–µ—Ç–∞–ª–∏ –¥–ª—è SQL)

```json
{
  "source_query": "SELECT ... FROM content.film_work ...",
  "target_table": "analytics.film_dim",
  "mode": "full",
  "batch_size": 5000,
  "incremental_key": "modified"
}
```

### 2.3. PipelineState

```json
{
  "pipeline_id": "uuid",
  "last_processed_id": "cc32e6da-...",
  "last_processed_value": "2025-01-01T00:00:00Z", // –¥–ª—è incremental –ø–æ –¥–∞—Ç–µ
  "updated_at": "2025-01-01T11:00:00Z"
}
```

### 2.4. PipelineRun

```json
{
  "id": "uuid",
  "pipeline_id": "uuid",
  "started_at": "2025-01-01T11:00:00Z",
  "finished_at": "2025-01-01T11:02:30Z",
  "rows_read": 10000,
  "rows_written": 9800,
  "status": "SUCCESS",     // SUCCESS / FAILED
  "error_message": null
}
```

---

## 3. –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–æ –ø–∞–π–ø–ª–∞–π–Ω–∞–º

### 3.1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–∞–π–ø–ª–∞–π–Ω–æ–≤

`GET /api/v1/pipelines`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤ —Å –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
[
  {
    "id": "f0f2f3b0-...",
    "name": "film_dim_full",
    "type": "SQL",
    "mode": "full",
    "enabled": true,
    "status": "IDLE",
    "target_table": "analytics.film_dim",
    "batch_size": 5000
  },
  {
    "id": "a1b2c3d4-...",
    "name": "film_rating_agg_incremental",
    "type": "SQL",
    "mode": "incremental",
    "enabled": true,
    "status": "PAUSED",
    "target_table": "analytics.film_rating_agg",
    "batch_size": 2000
  }
]
```

---

### 3.2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω

`POST /api/v1/pipelines`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω. –ù–∞ —É—Ä–æ–≤–Ω–µ MVP ‚Äî —Ç–æ–ª—å–∫–æ SQL-–ø–∞–π–ø–ª–∞–π–Ω—ã.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞ (SQL-–ø–∞–π–ø–ª–∞–π–Ω):**

```json
{
  "name": "film_dim_full",
  "description": "–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏—Ç—Ä–∏–Ω—ã –ø–æ —Ñ–∏–ª—å–º–∞–º",
  "type": "SQL",
  "mode": "full",
  "enabled": true,
  "target_table": "analytics.film_dim",
  "batch_size": 5000,
  "source_query": "SELECT id, title, rating, modified FROM content.film_work"
}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (201 Created):**

```json
{
  "id": "f0f2f3b0-...",
  "name": "film_dim_full",
  "description": "–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏—Ç—Ä–∏–Ω—ã –ø–æ —Ñ–∏–ª—å–º–∞–º",
  "type": "SQL",
  "mode": "full",
  "enabled": true,
  "status": "IDLE",
  "target_table": "analytics.film_dim",
  "batch_size": 5000,
  "incremental_key": null,
  "created_at": "2025-01-01T10:00:00Z",
  "updated_at": "2025-01-01T10:00:00Z"
}
```

*(–ø–æ–¥—Ä–æ–±–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –æ–ø–∏—Å–∞—Ç—å –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è Pydantic-—Å—Ö–µ–º—ã)*

---

### 3.3. –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞

`GET /api/v1/pipelines/{pipeline_id}`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–∞–π–ø–ª–∞–π–Ω–∞, –≤–∫–ª—é—á–∞—è SQL –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "id": "f0f2f3b0-...",
  "name": "film_dim_full",
  "description": "–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏—Ç—Ä–∏–Ω—ã –ø–æ —Ñ–∏–ª—å–º–∞–º",
  "type": "SQL",
  "mode": "full",
  "enabled": true,
  "status": "IDLE",
  "target_table": "analytics.film_dim",
  "batch_size": 5000,
  "incremental_key": null,
  "source_query": "SELECT id, title, rating, modified FROM content.film_work",
  "created_at": "2025-01-01T10:00:00Z",
  "updated_at": "2025-01-01T10:00:00Z"
}
```

---

### 3.4. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–∞–π–ø–ª–∞–π–Ω–∞

`PATCH /api/v1/pipelines/{pipeline_id}`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ß–∞—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–æ–ª–µ–π).
–ù–∞–ø—Ä–∏–º–µ—Ä, –∏–∑–º–µ–Ω–µ–Ω–∏–µ batch_size –∏–ª–∏ source_query, –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞.

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**

```json
{
  "batch_size": 10000,
  "enabled": false,
  "source_query": "SELECT id, title, rating, modified FROM content.film_work WHERE rating IS NOT NULL"
}
```

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "id": "f0f2f3b0-...",
  "name": "film_dim_full",
  "type": "SQL",
  "mode": "full",
  "enabled": false,
  "status": "IDLE",
  "target_table": "analytics.film_dim",
  "batch_size": 10000,
  "source_query": "SELECT id, title, rating, modified FROM content.film_work WHERE rating IS NOT NULL",
  "incremental_key": null,
  "created_at": "2025-01-01T10:00:00Z",
  "updated_at": "2025-01-01T12:30:00Z"
}
```

*(–ø—Ä–∞–≤–∏–ª–∞, —á—Ç–æ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä–∏ `RUNNING`, –±—É–¥—É—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Runner)*

---

## 4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–º –ø–∞–π–ø–ª–∞–π–Ω–æ–≤

### 4.1. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∑–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞

`POST /api/v1/pipelines/{pipeline_id}/run`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å `RUN_REQUESTED`. Runner –ø–æ–¥–±–µ—Ä—ë—Ç –ø–∞–π–ø–ª–∞–π–Ω –∏ –Ω–∞—á–Ω—ë—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "pipeline_id": "f0f2f3b0-...",
  "status": "RUN_REQUESTED"
}
```

---

### 4.2. –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ø–∞—É–∑—É –ø–∞–π–ø–ª–∞–π–Ω–∞

`POST /api/v1/pipelines/{pipeline_id}/pause`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å `PAUSE_REQUESTED`. Runner –∑–∞–≤–µ—Ä—à–∏—Ç —Ç–µ–∫—É—â–∏–π –±–∞—Ç—á –∏ –ø–µ—Ä–µ–≤–µ–¥—ë—Ç –ø–∞–π–ø–ª–∞–π–Ω –≤ `PAUSED`.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "pipeline_id": "f0f2f3b0-...",
  "status": "PAUSE_REQUESTED"
}
```

---

### 4.3. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞

`GET /api/v1/pipelines/{pipeline_id}/status`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å –∏ –∫—Ä–∞—Ç–∫—É—é –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "pipeline_id": "f0f2f3b0-...",
  "status": "RUNNING",
  "last_run_id": "cafe-babe-...",
  "last_updated_at": "2025-01-01T11:01:00Z"
}
```

---

## 5. –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∏

### 5.1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ (state)

`GET /api/v1/pipelines/{pipeline_id}/state`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç checkpoint –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "pipeline_id": "f0f2f3b0-...",
  "last_processed_id": "cc32e6da-...",
  "last_processed_value": "2025-01-01T00:00:00Z",
  "updated_at": "2025-01-01T11:00:00Z"
}
```

---

### 5.2. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—Å–∫–æ–≤ –ø–∞–π–ø–ª–∞–π–Ω–∞

`GET /api/v1/pipelines/{pipeline_id}/runs`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—É—Å–∫–æ–≤ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N, —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –≤ –±—É–¥—É—â–µ–º).

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
[
  {
    "id": "run-1-uuid",
    "pipeline_id": "f0f2f3b0-...",
    "started_at": "2025-01-01T11:00:00Z",
    "finished_at": "2025-01-01T11:02:30Z",
    "rows_read": 10000,
    "rows_written": 9800,
    "status": "SUCCESS",
    "error_message": null
  },
  {
    "id": "run-2-uuid",
    "pipeline_id": "f0f2f3b0-...",
    "started_at": "2025-01-02T11:00:00Z",
    "finished_at": "2025-01-02T11:01:10Z",
    "rows_read": 5000,
    "rows_written": 5000,
    "status": "FAILED",
    "error_message": "duplicate key value violates unique constraint ..."
  }
]
```

---

## 6. Reconcile (—Å–≤–µ—Ä–∫–∞ source/target)

### 6.1. –ó–∞–ø—É—Å–∫ reconcile –¥–ª—è –ø–∞–π–ø–ª–∞–π–Ω–∞

`POST /api/v1/pipelines/{pipeline_id}/reconcile` *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ)*

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–≤–µ—Ä–∫—É –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É source –∏ target –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (—á–µ—Ä–Ω–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç):**

```json
{
  "pipeline_id": "f0f2f3b0-...",
  "source_count": 10500,
  "target_count": 10480,
  "difference": 20,
  "status": "WARNING"
}
```

---

## 7. Healthcheck

### 7.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞

`GET /api/v1/health`

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ API –∂–∏–≤–æ –∏ –º–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è —Å –±–∞–∑–æ–π.

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**

```json
{
  "status": "ok",
  "db": "ok",
  "version": "0.1.0"
}
```

---

## 8. TBD / –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ–∑–∂–µ

1. –§–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ (—Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π JSON —Å –∫–æ–¥–∞–º–∏, –ø–æ–ª—è–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏).
2. –ü–∞–≥–∏–Ω–∞—Ü–∏—è –≤ `GET /pipelines` –∏ `GET /pipelines/{id}/runs`.
3. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É/—Ç–∏–ø—É –ø–∞–π–ø–ª–∞–π–Ω–∞ –≤ `GET /pipelines`.
4. –û—Ç–¥–µ–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è Python-—Ç–∞—Å–∫–æ–≤ (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è).
5. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è/–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ dev-—Å—Ç–µ–Ω–¥–∞ –∏/–∏–ª–∏ basic auth, –Ω–æ —ç—Ç–æ —Ñ–∞–∫—É–ª—å—Ç–∞—Ç–∏–≤–Ω–æ –¥–ª—è –¥–∏–ø–ª–æ–º–∞).

---

*–≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî —á–µ—Ä–Ω–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç.
–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è 2 –Ω–µ–¥–µ–ª–∏ –æ–Ω –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –º–æ–¥–µ–ª—è–º FastAPI/pydantic.*

```
```
